---
import Layout from '../layouts/Layout.astro';
import { VaultManifestClient } from 'moltenobsidian-ssg-client/manifest-client';
import { VaultManifest, VaultFile } from "moltenobsidian-ssg-client/vault-manifest";
import manifest from '../assets/vault/moltenobsidian.manifest.json';
import fs from 'node:fs/promises';


export const manifestClient = VaultManifestClient.fromManifest(manifest as VaultManifest);

export function toRelativeVaultPath(path) {
    return `../assets/vault/${path}`;
}

export async function getStaticPaths() {
    const paths = [];
    
    for (const path of manifestClient.routingTable.keys()) {        
        const ssgPath = new URL(toRelativeVaultPath(manifestClient.getAssetPath(path)), import.meta.url);
        const frontMatterPath = new URL(manifestClient.getFrontMatterFilePath(toRelativeVaultPath(manifestClient.getAssetPath(path))), import.meta.url);
        
        const content = await fs.readFile(ssgPath, 'utf-8');
        const frontMatter =  VaultManifestClient.getFrontMatter(await fs.readFile(frontMatterPath, 'utf-8'));
        
        console.log(frontMatter);
        
        if (frontMatter.obsidian?.publish === false || frontMatter.moltenobsidian?.publish === false) continue;
        
        paths.push({
            params: {path: path === '' ? undefined : path},
            props: {
                content: content,
                ...frontMatter
            }
        });
    }

    console.log(paths);
    return paths;
}

const { path } = Astro.params;
const { content, cssclasses } = Astro.props;
---

<Layout>
    <code>Path: {path ?? "undefined"}</code>
    <hr style="margin: 3rem;" />
    
    <article class:list={cssclasses}>
        <Fragment set:html={content} />
    </article>
</Layout>